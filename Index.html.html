<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒØ³Ù‡ Ø±Ù†Ú¯â€ŒÙ‡Ø§ â€“ Ø­Ø§Ù„Øª ÙØ§ÛŒÙ„ (Ø¨Ø¯ÙˆÙ† Ø°Ø®ÛŒØ±Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø±)</title>
<style>
  body{font-family:Tahoma, sans-serif;background:#f6f8fb;margin:0;color:#111}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  .section{background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin:14px 0;padding:16px}
  h1{margin:0 0 10px 0;color:#0f172a}
  h3{margin:0 0 12px 0;color:#111827}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  input,select,button{padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
  button{background:#0f766e;color:#fff;border:none;font-weight:600;cursor:pointer}
  button:disabled{opacity:.6;cursor:default}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
  th{background:#f3f4f6}
  .muted{color:#6b7280;font-size:.92em}
  .chip{display:inline-block;background:#111827;color:#fff;border-radius:6px;padding:2px 8px;margin-left:6px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .w-2{flex:2 1 0} .w-1{flex:1 1 0}
  .danger{background:#b91c1c}
  .accent{background:#1d4ed8}
  .pdf-btn{background:#334155}
  .badge{background:#111827;color:#fff;padding:2px 8px;border-radius:6px;margin-right:8px;font-size:.8em}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .warn{background:#7f1d1d;color:#fff;padding:8px 12px;border-radius:8px}
  .ok{background:#065f46;color:#fff;padding:8px 12px;border-radius:8px}
  @media (max-width:720px){ .grid{grid-template-columns:1fr} }
  @media print{ .no-print{display:none} .section{page-break-inside:avoid} }
</style>
</head>
<body>
<div class="container">
  <div class="topbar no-print">
    <div class="row">
      <h1 style="font-size:30px;font-weight:700;font-family:'Tahoma','Vazirmatn','IRANSans',sans-serif;color:#0f766e;text-shadow:2px 2px 4px rgba(0,0,0,0.2);">Ø§Ù†Ø¨Ø§Ø± Ø±Ù†Ú¯ ÙØ±Ø§Ø²</h1>
      
    </div>
    
  </div>
  <div id="note" class="ok no-print" style="display:none"></div>
  <div id="warn" class="warn no-print" style="display:none"></div>

  <!-- Ø§Ø®Ø·Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙØ± -->
  <div class="section" id="zero-alert">
    <h3>âš ï¸ Ø§Ø®Ø·Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙØ±</h3>
<div class="toolbar no-print">
  <button id="btn-zero-show" class="accent">Ù†Ù…Ø§ÛŒØ´</button>
  <button id="btn-zero-pdf" class="pdf-btn">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
</div>
    <div id="zero-list" class="muted" style="display:none">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒâ€ŒÙ‡Ø§...</div>
  </div>

  <!-- ØªØ¹Ø±ÛŒÙ Ú©Ø§Ù„Ø§ -->
  <div class="section" id="define">
    <h3>ØªØ¹Ø±ÛŒÙ Ú©Ø§Ù„Ø§</h3>
    <div class="grid">
      <input id="f-group" placeholder="Ú©Ø¯ Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ">
      <input id="f-code" placeholder="Ú©Ø¯ Ø±Ù†Ú¯">
      <input id="f-qty" type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ (Ú©ÛŒØ³Ù‡)">
      <input id="f-bag" type="number" placeholder="Ù‚ÛŒÙ…Øª Ú©ÛŒØ³Ù‡">
      <input id="f-kilo" type="number" placeholder="Ù‚ÛŒÙ…Øª Ú©ÛŒÙ„Ùˆ">
    </div>
    <div class="toolbar">
      <button id="btn-add">Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ù„Ø§</button>
    </div>
  </div>

  <!-- ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬ -->
  <div class="section" id="io">
    <h3>ÙˆØ±ÙˆØ¯ / Ø®Ø±ÙˆØ¬</h3>
    <div class="grid">
      <select id="io-group"><option value="">â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”</option></select>
      <select id="io-code"><option value="">â€” Ú©Ø¯ Ø±Ù†Ú¯ â€”</option></select>
      <input id="io-date" type="date" />
      <input id="io-qty" type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯ (Ú©ÛŒØ³Ù‡)">
    </div>
    <div class="toolbar">
      <button id="btn-in">ÙˆØ±ÙˆØ¯</button>
      <button id="btn-out" class="danger">Ø®Ø±ÙˆØ¬</button>
      <button id="btn-io-pdf" class="pdf-btn">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
    </div>
    <div id="io-log" class="muted"></div>
  </div>

  <!-- Ø§ØµÙ„Ø§Ø­ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ -->
  
    <!-- ğŸ”¸ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ùˆ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ -->
    <h4 style="margin-top:14px"><span class="chip">Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡</span></h4>
    <div class="grid no-print">
      <input id="rep-date" type="date" placeholder="ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´">
    </div>
    <div class="toolbar no-print">
      <button id="rep-daily-show" class="accent">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡</button>
      <button id="rep-daily-pdf" class="btn-accent">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
    </div>
    <div id="rep-daily"></div>

    <h4 style="margin-top:14px"><span class="chip">Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ (ÙˆØ±ÙˆØ¯ / Ø®Ø±ÙˆØ¬ / Ù…ÙˆØ¬ÙˆØ¯ÛŒ)</span></h4>
    <div class="grid no-print">
      <input id="rep-from" type="date" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®">
      <input id="rep-to" type="date" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®">
    </div>
    <div class="toolbar no-print">
      <button id="rep-range-show" class="accent">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ</button>
      <button id="rep-range-pdf" class="btn-accent">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
    </div>
    <div id="rep-range"></div>
<div class="section" id="edit-tx">
    <h3>ğŸ› ï¸ Ø§ØµÙ„Ø§Ø­ ØªØ§Ø±ÛŒØ® / ØªØ¹Ø¯Ø§Ø¯</h3>
    <div class="grid no-print">
      <select id="edit-group"><option value="">â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”</option></select>
      <select id="edit-code"><option value="">â€” Ú©Ø¯ Ø±Ù†Ú¯ â€”</option></select>
      <input id="edit-from" type="date" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®">
      <input id="edit-to" type="date" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®">
      <div class="row no-print"><button id="edit-set-today" type="button">ØªØ§ Ø§Ù…Ø±ÙˆØ²</button><button id="edit-clear-dates" type="button" style="margin-right:6px">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§</button></div>
    </div>
    <div class="toolbar no-print">
      <button id="btn-edit-search" class="accent">Ø¬Ø³ØªØ¬Ùˆ</button>
    </div>
    <div id="edit-results"></div>
  </div>

  <!-- Ú¯Ø²Ø§Ø±Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ -->
  <div class="section" id="inventory">
    <h3>Ú¯Ø²Ø§Ø±Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ</h3>
    <div class="grid no-print">
      <select id="inv-group"><option value="">â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”</option></select>
      <input id="inv-from" type="date" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®">
      <input id="inv-to" type="date" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®">
      <input id="inv-search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ø¯">
    </div>
    <div class="toolbar no-print">
      <button id="btn-inv-show" class="accent">Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
      <button id="btn-inv-csv" class="accent">Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
      <button id="btn-inv-pdf" class="pdf-btn">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
    </div>
    <div id="inv-table"></div>
  </div>

  <!-- Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª -->
  <div class="section" id="price">
    <h3>ğŸ’² Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª</h3>
    <div class="grid no-print">
      <select id="price-group"><option value="">â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”</option></select>
      <select id="price-code"><option value="">â€” Ú©Ø¯ Ø±Ù†Ú¯ â€”</option></select>
      <input id="price-direct" placeholder="ÛŒØ§ Ú©Ø¯ Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    </div>
    <div class="toolbar no-print">
      <button id="btn-price">Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øª</button>
      <button id="btn-price-pdf" class="pdf-btn">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
    </div>
    <div id="price-result" class="muted"></div>
  </div>

  <!-- Ù„ÛŒØ³Øª Ù‚ÛŒÙ…Øª -->
  <div class="section" id="pricelist">
    <h3>ğŸ§¾ Ù„ÛŒØ³Øª Ù‚ÛŒÙ…Øª Ú©Ù„ÛŒ (ØªÙÚ©ÛŒÚ© Ø±Ù†Ú¯)</h3>
    <div class="grid no-print">
      <select id="pl-group"><option value="">â€” Ù‡Ù…Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ â€”</option></select>
      <div></div><div></div>
    </div>
    <div class="toolbar no-print">
      <button id="btn-pl-show" class="accent">Ù†Ù…Ø§ÛŒØ´</button>
      <button id="btn-pl-csv">Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
      <button id="btn-pl-pdf" class="pdf-btn">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
    </div>
    <div id="pl-result"></div>
  </div>

  <!-- Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ / Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ (Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡) -->
  
  <!-- Ø§ØµÙ„Ø§Ø­ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ -->
  <div class="section" id="edit-price">
    <h3>ğŸ› ï¸ Ø§ØµÙ„Ø§Ø­ Ù‚ÛŒÙ…Øª</h3>
    <div class="grid no-print">
      <select id="priceedit-group"><option value="">â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”</option></select>
      <select id="priceedit-code"><option value="">â€” Ú©Ø¯ Ø±Ù†Ú¯ â€”</option></select>
      <div></div>
      <input id="priceedit-bag" type="number" placeholder="Ù‚ÛŒÙ…Øª Ú©ÛŒØ³Ù‡ (Ø¬Ø¯ÛŒØ¯)">
      <input id="priceedit-kilo" type="number" placeholder="Ù‚ÛŒÙ…Øª Ú©ÛŒÙ„Ùˆ (Ø¬Ø¯ÛŒØ¯)">
      <div class="muted">Ù‡Ø± ÙÛŒÙ„Ø¯ÛŒ Ø±Ø§ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØŒ Ù‡Ù…Ø§Ù† Ù‚ÛŒÙ…Øª Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.</div>
    </div>
    <div class="toolbar no-print">
      <button id="btn-priceedit-fill" class="accent">Ù†Ù…Ø§ÛŒØ´ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ</button>
      <button id="btn-priceedit-save">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±</button>
    </div>
    <div id="priceedit-current" class="muted"></div>
  </div>

  
  <!-- ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ -->
  <div class="section" id="analytics">
    <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ</h3>
    <div class="muted">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ ÙÙ‚Ø· Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ù†Ø¯ Ùˆ Ú†ÛŒØ²ÛŒ Ø±Ø§ ØªØºÛŒÛŒØ± Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯.</div>
    <div class="grid no-print" style="margin-top:8px">
      <input id="ana-from" type="date" placeholder="Ø§Ø² ØªØ§Ø±ÛŒØ®">
      <input id="ana-to" type="date" placeholder="ØªØ§ ØªØ§Ø±ÛŒØ®">
      <select id="ana-group"><option value="">â€” Ù‡Ù…Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ â€”</option></select>
      <select id="ana-code"><option value="">â€” Ù‡Ù…Ù‡ Ú©Ø¯Ù‡Ø§ â€”</option></select>
    </div>
    <div class="toolbar no-print">
      <button id="ana-refresh">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
      <button id="ana-pdf" class="btn-accent">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF</button>
    </div>

    <!-- 1) Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡ -->
    <h4 style="margin-top:14px"><span class="chip">Û±) Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø®Ø±ÙˆØ¬)</span></h4>
    <div class="toolbar no-print">
      <button id="ana-monthly-pdf" class="btn-accent">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF Ù‡Ù…ÛŒÙ† Ø¬Ø¯ÙˆÙ„</button>
    </div>
    <div id="ana-monthly"></div>

    <!-- 2) Ù¾Ø±Ù…ØµØ±Ùâ€ŒØªØ±ÛŒÙ† Ø±Ù†Ú¯â€ŒÙ‡Ø§ -->
    <h4 style="margin-top:14px"><span class="chip">Û²) Ù¾Ø±Ù…ØµØ±Ùâ€ŒØªØ±ÛŒÙ† Ø±Ù†Ú¯â€ŒÙ‡Ø§</span></h4>
    <div class="grid no-print">
      <input id="ana-top-n" type="number" min="1" value="10" placeholder="Top N">
    </div>
    <div class="toolbar no-print">
      <button id="ana-top-pdf" class="btn-accent">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF Ù‡Ù…ÛŒÙ† Ø¬Ø¯ÙˆÙ„</button>
    </div>
    <div id="ana-top"></div>

    <!-- 3) Ø¨Ø¯ÙˆÙ† Ù…ØµØ±Ù Ø¯Ø± Ø¨Ø§Ø²Ù‡ -->
    <h4 style="margin-top:14px"><span class="chip">Û³) Ø¨Ø¯ÙˆÙ† Ù…ØµØ±Ù Ø¯Ø± Ø¨Ø§Ø²Ù‡</span></h4>
    <div class="toolbar no-print">
      <button id="ana-idle-pdf" class="btn-accent">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF Ù‡Ù…ÛŒÙ† Ø¬Ø¯ÙˆÙ„</button>
    </div>
    <div id="ana-idle"></div>

    <!-- 4) Ù…ÙˆØ¬ÙˆØ¯ÛŒ + Ø§Ø±Ø²Ø´ Ø±ÛŒØ§Ù„ÛŒ -->
    <h4 style="margin-top:14px"><span class="chip">Û´) Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ² + Ø§Ø±Ø²Ø´ Ø±ÛŒØ§Ù„ÛŒ</span></h4>
    <div class="toolbar no-print">
      <button id="ana-value-pdf" class="btn-accent">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF Ù‡Ù…ÛŒÙ† Ø¬Ø¯ÙˆÙ„</button>
    </div>
    <div id="ana-value"></div>
    
    <!-- 5) ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬ Ø¯Ø± Ø¨Ø§Ø²Ù‡ -->
    <h4 style="margin-top:14px"><span class="chip">Ûµ) ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬ Ø¯Ø± Ø¨Ø§Ø²Ù‡</span></h4>
    <div class="toolbar no-print">
      <button id="ana-moves-pdf" class="btn-accent">Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF Ù‡Ù…ÛŒÙ† Ø¬Ø¯ÙˆÙ„</button>
    </div>
    <div id="ana-moves"></div>
    
  </div>

  <div class="section" id="backup">
    <h3>ğŸ“¦ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ / Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ</h3>
    <div class="toolbar no-print">
      <button id="btn-backup-bottom">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾ (JSON)</button>
      <input id="file-restore-bottom" type="file" accept="application/json">
      <button id="btn-restore-bottom" class="accent">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² ÙØ§ÛŒÙ„</button>
    </div>
    <div class="muted">Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø´Ø§Ù…Ù„ Ù‡Ù…Ù‡Ù” Ú©Ø§Ù„Ø§Ù‡Ø§ØŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡Ù” ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§Ø³Øª.</div>
  </div>
</div>


<script>

  // === Shamsi (Jalali) display only ===
  const DISPLAY_SHAMSI = true;
  (function(){
    if(!DISPLAY_SHAMSI) return;
    try {
      const shamsiFmt = new Intl.DateTimeFormat('fa-IR-u-ca-persian', { year:'numeric', month:'2-digit', day:'2-digit' });
      const _toLDS = Date.prototype.toLocaleDateString;
      Date.prototype.toLocaleDateString = function(locale, options){
        try { return shamsiFmt.format(this); } catch(e) { return _toLDS.call(this, locale, options); }
      };
      window.toShamsi = function(d){
        try { return shamsiFmt.format(new Date(d)); } catch(e) { return d; }
      };
    } catch (e) {
      console.warn('Shamsi Intl formatter not available:', e);
      window.toShamsi = function(d){ return d; };
    }
    window.postProcessDates = function(root){
      if(!DISPLAY_SHAMSI) return;
      const scope = root || document;
      const nodes = scope.querySelectorAll('.report table td, .report table th, table td, table th, span.date, .date-cell');
      nodes.forEach(el=>{
        const t = (el.textContent||'').trim();
        if(/^\d{4}[-\/]\d{2}[-\/]\d{2}/.test(t)){
          const iso = t.replace(/\//g,'-');
          const d = new Date(iso);
          if(!isNaN(d.getTime())){
            el.textContent = toShamsi(d);
          }
        }
      });
    };
  })();


  const BAG_SIZE = 25; // Ù‡Ø± Ú©ÛŒØ³Ù‡ 25 Ú©ÛŒÙ„Ùˆ

(function(){
  // ===== In-memory DB (File Mode) =====
  window.DB = { items: [], txns: [] };
  // ===== LocalStorage persistence (AUTO-SAVE) =====
  function saveToLocal(){
    try{ localStorage.setItem("colorsDB", JSON.stringify(DB)); }catch(e){ /* ignore quota errors */ }
  }
  function loadFromLocal(){
    try{
      const raw = localStorage.getItem("colorsDB");
      if(raw){
        const obj = JSON.parse(raw);
        if(obj && Array.isArray(obj.items) && Array.isArray(obj.txns)){
          DB.items = obj.items; DB.txns = obj.txns;
        }
      }
    }catch(e){ /* ignore parse errors */ }
  }
  // Load immediately (before first render)
  loadFromLocal();

  let dirty = false;

  function el(id){ return document.getElementById(id); }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  el("io-date").value = todayISO();

  function note(msg){ const n=el("note"); if(!n) return; n.textContent=msg; n.style.display="block"; setTimeout(()=> n.style.display="none", 2500); }
  function warn(msg){ const w=el("warn"); if(!w) return; w.textContent=msg; w.style.display="block"; }

  // ===== File Save / Load =====
  function downloadJSON(name, obj){
    const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = name; a.click();
  }
  if(el("btn-save")) el("btn-save").addEventListener("click", function(){
    downloadJSON("colors_data.json", DB);
    dirty = false; note("âœ… ÙØ§ÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
  });
  if(el("btn-load")) el("btn-load").addEventListener("click", function(){
    const f = el("file-load").files[0];
    if(!f){ warn("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ JSON Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
    const r = new FileReader();
    r.onload = function(){
      try{
        const data = JSON.parse(r.result);
        if(data && Array.isArray(data.items) && Array.isArray(data.txns)){
          DB.items = data.items; DB.txns = data.txns; dirty=false;
          refreshAll(); note("âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.");
        }else if(Array.isArray(data)){
          DB.items = data; DB.txns = []; dirty=false; refreshAll(); note("âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (ÙØ±Ù…Øª Ù‚Ø¯ÛŒÙ…ÛŒ) Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.");
        }else{ warn("ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª."); }
      }catch(e){ warn("Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯."); }
    };
    r.readAsText(f);
  });

  // ===== Helpers =====
  function groups(){ return Array.from(new Set(DB.items.map(x=>x.group).filter(Boolean))).sort(); }
  function fillGroupSelect(sel, allLabel){
    const cur = sel.value;
    sel.innerHTML = "";
    const o0 = document.createElement("option"); o0.value=""; o0.textContent=allLabel||"â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”"; sel.appendChild(o0);
    groups().forEach(g=>{ const o=document.createElement("option"); o.value=g; o.textContent=g; sel.appendChild(o); });
    if(cur && groups().includes(cur)) sel.value=cur;
  }
  function fillCodeByGroup(groupSel, codeSel){
    const g = groupSel.value;
    const its = DB.items;
    const cur = codeSel.value;
    codeSel.innerHTML = "";
    const o0 = document.createElement("option"); o0.value=""; o0.textContent="â€” Ú©Ø¯ Ø±Ù†Ú¯ â€”"; codeSel.appendChild(o0);
    its.filter(i=> !g || i.group===g).forEach(i=>{ const o=document.createElement("option"); o.value=i.code; o.textContent=i.code; codeSel.appendChild(o); });
    codeSel.value = cur;
  }
  function table(headers, rows){
    const t = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
    thead.appendChild(trh); t.appendChild(thead);
    const tb = document.createElement("tbody");
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      r.forEach(c=>{ const td=document.createElement("td"); td.textContent=(c==null? "": c); tr.appendChild(td); });
      tb.appendChild(tr);
    });
    t.appendChild(tb);
    return t;
  }
  function exportPDF(sectionId, title){
    const node = el(sectionId);
    if(!node){ alert("Ø¨Ø®Ø´ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."); return; }
    const win = window.open("", "_blank");
    const styles = `
      <style>
        @page { size: A4; margin: 16mm; }
        body { font-family: Tahoma, sans-serif; color:#111; }
        h1,h2,h3{ margin:0 0 8px 0; }
        .header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .meta{ color:#6b7280; font-size:12px; }
        table{ width:100%; border-collapse:collapse; }
        th,td{ border:1px solid #e5e7eb; padding:6px; text-align:center; font-size:12px; }
        th{ background:#f3f4f6; }
        .group-title{ background:#111827; color:#fff; padding:4px 8px; border-radius:6px; display:inline-block; margin:10px 0 6px 0; }
      </style>`;
    const content = node.cloneNode(true);
    content.querySelectorAll('.no-print, .toolbar').forEach(e=> e.remove());
    const now = new Date().toLocaleString("fa-IR");
    win.document.write(`<!DOCTYPE html><html dir="rtl" lang="fa"><head><meta charset="utf-8"><title>${title}</title>${styles}</head><body>`);
    win.document.write(`<div class="header"><h2>${title}</h2><div class="meta">${now}</div></div>`);
    win.document.body.appendChild(content);
    win.document.write(`
</body></html>`);
    win.document.close(); setTimeout(()=> win.print(), 300);
  }

  // ===== Quantity computation =====
  function computeQty(code){
    const it = DB.items.find(i=> i.code===code);
    if(!it) return 0;
    const base = (typeof it.qty0 === 'number') ? it.qty0 : (typeof it.qty === 'number' ? it.qty : 0);
    const delta = DB.txns.filter(t=> t.code===code).reduce((s,t)=> s + (t.type==='in'? +t.qty : -t.qty), 0);
    return base + delta;
  }
  function computeQtyAtDate(code, dateTo){
    const it = DB.items.find(i=> i.code===code);
    if(!it) return 0;
    const base = (typeof it.qty0 === 'number') ? it.qty0 : (typeof it.qty === 'number' ? it.qty : 0);
    const cutoff = dateTo || "9999-12-31";
    const delta = DB.txns.filter(t=> t.code===code && (t.date||"") <= cutoff)
                         .reduce((s,t)=> s + (t.type==='in'? +t.qty : -t.qty), 0);
    return base + delta;
  }

  // ===== Define Item =====
  el("btn-add").addEventListener("click", function(){
    const group = (el("f-group").value||"").trim();
    const code  = (el("f-code").value||"").trim();
    const qty   = parseInt(el("f-qty").value, 10);
    const bag   = parseFloat(el("f-bag").value);
    const kilo  = parseFloat(el("f-kilo").value);
    if(!group || !code || isNaN(qty)){ warn("Ú¯Ø±ÙˆÙ‡ØŒ Ú©Ø¯ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª."); return; }
    if(DB.items.some(i=> i.code===code)){ warn("Ø§ÛŒÙ† Ú©Ø¯ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª."); return; }
    DB.items.push({group, code, qty: qty, qty0: qty, bagPrice: isNaN(bag)? null: bag, kiloPrice: isNaN(kilo)? null: kilo});
    el("f-group").value = el("f-code").value = el("f-qty").value = el("f-bag").value = el("f-kilo").value = "";
    dirty = true; 
    try{ saveToLocal(); }catch(e){}note("âœ… Ú©Ø§Ù„Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒ Â«Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„ Ø¯Ø§Ø¯Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯)");
    refreshAll();
  });

  // ===== I/O =====
  el("io-group").addEventListener("change", ()=> fillCodeByGroup(el("io-group"), el("io-code")));
  el("btn-in").addEventListener("click", function(){
    const code = el("io-code").value; const q = parseInt(el("io-qty").value,10); const d = el("io-date").value || todayISO();
    if(!code || isNaN(q) || q<=0){ warn("Ú©Ø¯ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
    const it = DB.items.find(i=> i.code===code); if(!it){ warn("Ú©Ø§Ù„Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯."); return; }
    DB.txns.push({id: Date.now()+"-"+Math.random().toString(16).slice(2), code, qty:q, type:"in", date: d});
    el("io-qty").value=""; logIO("ÙˆØ±ÙˆØ¯", code, q, d); dirty=true; saveToLocal(); note("âœ… ØªØ±Ø§Ú©Ù†Ø´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯)"); refreshAll();
  });
  el("btn-out").addEventListener("click", function(){
    const code = el("io-code").value; const q = parseInt(el("io-qty").value,10); const d = el("io-date").value || todayISO();
    if(!code || isNaN(q) || q<=0){ warn("Ú©Ø¯ Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
    if(computeQty(code) < q){ warn("Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª."); return; }
    DB.txns.push({id: Date.now()+"-"+Math.random().toString(16).slice(2), code, qty:q, type:"out", date: d});
    el("io-qty").value=""; logIO("Ø®Ø±ÙˆØ¬", code, q, d); dirty=true; saveToLocal(); note("âœ… ØªØ±Ø§Ú©Ù†Ø´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯)"); refreshAll();
  });
  function logIO(type, code, qty, d){
    const area = el("io-log");
    const time = (d? d+" " : "") + new Date().toLocaleTimeString("fa-IR");
    const div = document.createElement("div");
    div.textContent = type + " " + qty + " Ú©ÛŒØ³Ù‡ | Ú©Ø¯ " + code + " | " + time;
    area.prepend(div);
  }
  el("btn-io-pdf").addEventListener("click", ()=> exportPDF("io","Ú¯Ø²Ø§Ø±Ø´ ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬"));

  // ===== Edit Transactions =====
  function fillEditSelectors(){
    const gsel = el("edit-group"); const csel = el("edit-code");
    const curG = gsel.value, curC = csel.value;
    gsel.innerHTML = ""; const g0=document.createElement("option"); g0.value=""; g0.textContent="â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”"; gsel.appendChild(g0);
    groups().forEach(g=>{ const o=document.createElement("option"); o.value=g; o.textContent=g; gsel.appendChild(o); });
    gsel.value = curG;
    csel.innerHTML = ""; const c0=document.createElement("option"); c0.value=""; c0.textContent="â€” Ú©Ø¯ Ø±Ù†Ú¯ â€”"; csel.appendChild(c0);
    DB.items.filter(i=> !gsel.value || i.group===gsel.value).forEach(i=>{ const o=document.createElement("option"); o.value=i.code; o.textContent=i.code; csel.appendChild(o); });
    csel.value = curC;
  }
  el("edit-group").addEventListener("change", fillEditSelectors);
  el("edit-set-today").addEventListener("click", ()=> el("edit-to").value = todayISO());
  el("edit-clear-dates").addEventListener("click", ()=> (el("edit-from").value="", el("edit-to").value=""));
  el("btn-edit-search").addEventListener("click", function(){
    const code = el("edit-code").value;
    const d1 = el("edit-from").value || "0000-01-01";
    const d2 = el("edit-to").value || "9999-12-31";
    const holder = el("edit-results"); holder.innerHTML = "";
    let tx = DB.txns.filter(t=> (!code || t.code===code) && (t.date>=d1 && t.date<=d2));
    tx.sort((a,b)=> (a.date<b.date? -1: a.date>b.date? 1: 0));
    if(tx.length===0){ const d=document.createElement("div"); d.className="muted"; d.textContent="Ú†ÛŒØ²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯."; holder.appendChild(d); return; }
    const t = document.createElement("table");
    const thead = document.createElement("thead"); const trh=document.createElement("tr");
    ["ØªØ§Ø±ÛŒØ®","Ù†ÙˆØ¹","Ú©Ø¯","ØªØ¹Ø¯Ø§Ø¯","Ø¹Ù…Ù„ÛŒØ§Øª"].forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
    thead.appendChild(trh); t.appendChild(thead);
    const tb = document.createElement("tbody");
    tx.forEach(row=>{
      const tr=document.createElement("tr"); tr.dataset.id=row.id;
      const tdD=document.createElement("td"); const inputD=document.createElement("input"); inputD.type="date"; inputD.value=row.date; tdD.appendChild(inputD);
      const tdT=document.createElement("td"); tdT.textContent = row.type==="in"?"ÙˆØ±ÙˆØ¯":"Ø®Ø±ÙˆØ¬";
      const tdC=document.createElement("td"); tdC.textContent = row.code;
      const tdQ=document.createElement("td"); const inputQ=document.createElement("input"); inputQ.type="number"; inputQ.value=row.qty; inputQ.style.width="90px"; tdQ.appendChild(inputQ);
      const tdA=document.createElement("td");
      const btnS=document.createElement("button"); btnS.textContent="Ø°Ø®ÛŒØ±Ù‡"; btnS.className="accent"; tdA.appendChild(btnS);
      const btnDel=document.createElement("button"); btnDel.textContent="Ø­Ø°Ù"; btnDel.className="danger"; btnDel.style.marginRight="6px"; tdA.appendChild(btnDel);

      tb.appendChild(tr);
      tr.appendChild(tdD); tr.appendChild(tdT); tr.appendChild(tdC); tr.appendChild(tdQ); tr.appendChild(tdA);

      btnS.addEventListener("click", function(){
        const newDate = inputD.value || row.date;
        const newQty = parseInt(inputQ.value,10);
        if(isNaN(newQty) || newQty<=0){ warn("ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª."); return; }
        // validate change (no negative)
        const before = computeQty(row.code);
        const delta = (row.type==="in"? 1:-1) * (newQty - row.qty);
        if(delta<0 && before < Math.abs(delta)){ warn("Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ø¹Ø« Ù…Ù†ÙÛŒ Ø´Ø¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯."); return; }
        // apply
        const idx = DB.txns.findIndex(t=> t.id===row.id);
        if(idx>=0){ DB.txns[idx].date=newDate; DB.txns[idx].qty=newQty; dirty=true; saveToLocal(); note("âœ… ØªØºÛŒÛŒØ±Ø§Øª ØªØ±Ø§Ú©Ù†Ø´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯)"); }
      });

      btnDel.addEventListener("click", function(){
        if(!confirm("Ø§ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
        const before = computeQty(row.code);
        const delta = (row.type==="in"? -row.qty : row.qty);
        if(delta<0 && before < Math.abs(delta)){ warn("Ø­Ø°Ù Ø¨Ø§Ø¹Ø« Ù…Ù†ÙÛŒ Ø´Ø¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯."); return; }
        DB.txns = DB.txns.filter(t=> t.id!==row.id); dirty=true; saveToLocal(); tr.remove(); note("âœ… Ø­Ø°Ù Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯)"); refreshAll();
      });
    });
    t.appendChild(tb); holder.appendChild(t);
  });

  // ===== Inventory Report =====
  function renderInventory(){
    const g = el("inv-group").value;
    const fromD = el("inv-from").value || "";
    const toD   = el("inv-to").value   || "";
    const itsRaw = DB.items.filter(i=> !g || i.group===g);
    const cutoff = toD || todayISO();
    const q = (el("inv-search").value||"").trim().toLowerCase();
    const its = itsRaw.map(i=> ({
      group: i.group, code: i.code,
      qty: computeQtyAtDate(i.code, cutoff),
      bagPrice: i.bagPrice, kiloPrice: i.kiloPrice
    })).filter(i=> !q || (i.code||"").toLowerCase().includes(q));
    const rows = its
      .sort((a,b)=> (a.group||"").localeCompare(b.group||"", "fa") || (a.code||"").localeCompare(b.code||"", "fa"))
      .map(i=> [i.group, i.code, i.qty, i.bagPrice==null?"-":i.bagPrice, i.kiloPrice==null?"-":i.kiloPrice]);
    const root = el("inv-table"); root.innerHTML=""; root.appendChild(table(["Ú¯Ø±ÙˆÙ‡","Ú©Ø¯","Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØªØ§ ØªØ§Ø±ÛŒØ®","Ù‚ÛŒÙ…Øª Ú©ÛŒØ³Ù‡","Ù‚ÛŒÙ…Øª Ú©ÛŒÙ„Ùˆ"], rows));
  }
  if(el("btn-inv-show")) el("btn-inv-show").addEventListener("click", renderInventory);
  el("btn-inv-csv").addEventListener("click", function(){
    const g = el("inv-group").value; const cutoff = (el("inv-to").value || todayISO());
    const q = (el("inv-search").value||"").trim().toLowerCase();
    const its = DB.items.filter(i=> !g || i.group===g).filter(i=> !q || (i.code||"").toLowerCase().includes(q));
    let csv = "group,code,qty_as_of,bag_price,kilo_price\n";
    its.forEach(i=>{ const qty=computeQtyAtDate(i.code, cutoff); csv += [i.group,i.code,qty,(i.bagPrice??""),(i.kiloPrice??"")].join(",") + "\n"; });
    downloadJSON("inventory.csv", csv);
  });
  el("btn-inv-pdf").addEventListener("click", ()=> exportPDF("inventory","Ú¯Ø²Ø§Ø±Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ"));

  // ===== Price Inquiry =====
  function fillPriceCodes(){ fillCodeByGroup(el("price-group"), el("price-code")); }
  el("price-group").addEventListener("change", fillPriceCodes);
  el("btn-price").addEventListener("click", function(){
    const code = el("price-code").value || el("price-direct").value.trim();
    if(!code){ warn("Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ ÛŒØ§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
    const it = DB.items.find(i=> i.code===code);
    const out = el("price-result");
    out.innerHTML = "";
    if(!it){ out.textContent = "Ú©Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯."; return; }
    const line1 = document.createElement("div");
    line1.textContent = "Ú¯Ø±ÙˆÙ‡: " + (it.group||"-") + " | Ú©Ø¯: " + it.code;
    const line2 = document.createElement("div");
    line2.textContent = "Ù‚ÛŒÙ…Øª Ú©ÛŒØ³Ù‡: " + (it.bagPrice==null?"-":it.bagPrice) + " | Ù‚ÛŒÙ…Øª Ú©ÛŒÙ„Ùˆ: " + (it.kiloPrice==null?"-":it.kiloPrice);
    out.appendChild(line1); out.appendChild(line2);
  });
  el("btn-price-pdf").addEventListener("click", ()=> exportPDF("price","Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚ÛŒÙ…Øª"));

  // ===== Price List =====
  el("btn-pl-show").addEventListener("click", function(){
    const g = el("pl-group").value;
    const its = DB.items.filter(i=> !g || i.group===g).sort((a,b)=> (a.group||"").localeCompare(b.group||"", "fa") || (a.code||"").localeCompare(b.code||"", "fa"));
    const by = {}; its.forEach(i=>{ (by[i.group||"-"] = by[i.group||"-"] || []).push(i); });
    const root = el("pl-result"); root.innerHTML="";
    if(its.length===0){ const d=document.createElement("div"); d.className="muted"; d.textContent="Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯."; root.appendChild(d); return; }
    const stat=document.createElement("div"); stat.className="muted"; stat.innerHTML="ØªØ¹Ø¯Ø§Ø¯ Ú¯Ø±ÙˆÙ‡: <b>"+Object.keys(by).length+"</b> | ØªØ¹Ø¯Ø§Ø¯ Ú©Ø¯: <b>"+its.length+"</b>"; root.appendChild(stat);
    Object.keys(by).sort().forEach(k=>{
      const h = document.createElement("h4"); const chip=document.createElement("span"); chip.className="chip"; chip.textContent=k; h.appendChild(chip); root.appendChild(h);
      const rows = by[k].map(i=> [i.code, i.bagPrice==null?"-":i.bagPrice, i.kiloPrice==null?"-":i.kiloPrice]);
      root.appendChild(table(["Ú©Ø¯","Ù‚ÛŒÙ…Øª Ú©ÛŒØ³Ù‡","Ù‚ÛŒÙ…Øª Ú©ÛŒÙ„Ùˆ"], rows));
    });
  });
  el("btn-pl-csv").addEventListener("click", function(){
    const g = el("pl-group").value;
    const its = DB.items.filter(i=> !g || i.group===g).sort((a,b)=> (a.group||"").localeCompare(b.group||"", "fa") || (a.code||"").localeCompare(b.code||"", "fa"));
    let csv = "group,code,bag_price,kilo_price\n";
    its.forEach(i=>{ csv += [i.group,i.code,(i.bagPrice??""),(i.kiloPrice??"")].join(",") + "\n"; });
    downloadJSON("price_list.csv", csv);
  });
  el("btn-pl-pdf").addEventListener("click", ()=> exportPDF("pricelist","Ù„ÛŒØ³Øª Ù‚ÛŒÙ…Øª Ú©Ù„ÛŒ (ØªÙÚ©ÛŒÚ© Ø±Ù†Ú¯)"));

  // ===== Zero-inventory alert =====
  function updateZeroAlert(){
    const its = DB.items.map(i=> ({group:i.group, code:i.code, qty: computeQty(i.code)}))
      .filter(i=> i.qty===0)
      .sort((a,b)=> (a.group||"").localeCompare(b.group||"", "fa") || (a.code||"").localeCompare(b.code||"", "fa"));
    const root = el("zero-list");
    if(!root) return;
    if(its.length===0){ root.textContent = "Ù‡ÛŒÚ† Ú©Ø§Ù„Ø§ÛŒ Ø¨Ø§ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙØ± ÛŒØ§ÙØª Ù†Ø´Ø¯."; return; }
    const ul = document.createElement("ul");
    its.forEach(i=>{ const li=document.createElement("li"); li.textContent = `ğŸ”´ Ú¯Ø±ÙˆÙ‡ ${i.group} | Ú©Ø¯ ${i.code} | Ù…ÙˆØ¬ÙˆØ¯ÛŒ: 0`; ul.appendChild(li); });
    root.innerHTML = ""; root.appendChild(ul);
  }

  
  // ===== Bottom Backup/Restore =====
  (function(){
    var btnB = document.getElementById("btn-backup-bottom");
    var inpR = document.getElementById("file-restore-bottom");
    var btnR = document.getElementById("btn-restore-bottom");
    if(btnB){
      btnB.addEventListener("click", function(){
        // same as top "Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„ Ø¯Ø§Ø¯Ù‡"
        const blob = new Blob([JSON.stringify(DB,null,2)], {type:"application/json"});
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "colors_data.json"; a.click();
        note("âœ… Ø¨Ú©â€ŒØ¢Ù¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯.");
      });
    }
    if(btnR){
      btnR.addEventListener("click", function(){
        const f = (inpR && inpR.files && inpR.files[0]) ? inpR.files[0] : null;
        if(!f){ warn("Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ JSON Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
        const r = new FileReader();
        r.onload = function(){
          try{
            const data = JSON.parse(r.result);
            if(data && Array.isArray(data.items) && Array.isArray(data.txns)){
              DB.items = data.items; DB.txns = data.txns;
              refreshAll(); note("âœ… Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.");
            }else if(Array.isArray(data)){
              DB.items = data; DB.txns = [];
              refreshAll(); note("âœ… Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ (ÙØ±Ù…Øª Ù‚Ø¯ÛŒÙ…ÛŒ).");
            }else{ warn("ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª."); }
          }catch(e){ warn("Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯."); }
        };
        r.readAsText(f);
      });
    }
  })();

  
  // ===== Edit Price (Ù‚ÛŒÙ…Øª) =====
  function fillPriceEditSelectors(){
    var gsel = el("priceedit-group"); var csel = el("priceedit-code");
    if(!gsel || !csel) return;
    // groups
    fillGroupSelect(gsel, "â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”");
    // codes by group
    const g = gsel.value || "";
    const items = DB.items;
    const curC = csel.value;
    csel.innerHTML = "";
    var o0=document.createElement("option"); o0.value=""; o0.textContent="â€” Ú©Ø¯ Ø±Ù†Ú¯ â€”"; csel.appendChild(o0);
    items.filter(i=> !g || i.group===g).forEach(i=>{ var o=document.createElement("option"); o.value=i.code; o.textContent=i.code; csel.appendChild(o); });
    if(curC && items.some(i=> i.code===curC)) csel.value = curC;
  }
  (function(){ 
    var gsel = el("priceedit-group");
    if(gsel) gsel.addEventListener("change", fillPriceEditSelectors);
  })();

  if(el("btn-priceedit-fill")) el("btn-priceedit-fill").addEventListener("click", function(){
    const code = el("priceedit-code")?.value;
    const out = el("priceedit-current");
    if(!code){ out.textContent = "Ú©Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."; return; }
    const it = DB.items.find(i=> i.code===code);
    if(!it){ out.textContent = "Ú©Ø§Ù„Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯."; return; }
    out.innerHTML = "Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ â€” Ú©ÛŒØ³Ù‡: <b>"+(it.bagPrice==null? "-" : it.bagPrice)+"</b> | Ú©ÛŒÙ„Ùˆ: <b>"+(it.kiloPrice==null? "-" : it.kiloPrice)+"</b>";
    if(el("priceedit-bag")) el("priceedit-bag").value = (it.bagPrice==null? "" : it.bagPrice);
    if(el("priceedit-kilo")) el("priceedit-kilo").value = (it.kiloPrice==null? "" : it.kiloPrice);
  });

  if(el("btn-priceedit-save")) el("btn-priceedit-save").addEventListener("click", function(){
    const code = el("priceedit-code")?.value;
    if(!code){ warn("Ú©Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
    const it = DB.items.find(i=> i.code===code);
    if(!it){ warn("Ú©Ø§Ù„Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯."); return; }
    const bag = parseFloat(el("priceedit-bag").value);
    const kilo = parseFloat(el("priceedit-kilo").value);
    let changed = false;
    if(!isNaN(bag)){ it.bagPrice = bag; changed = true; }
    if(!isNaN(kilo)){ it.kiloPrice = kilo; changed = true; }
    if(!changed){ warn("Ø¹Ø¯Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª."); return; }
    if(el("priceedit-current")) el("priceedit-current").innerHTML = "âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ â€” Ù‚ÛŒÙ…Øª Ø¬Ø¯ÛŒØ¯ â€” Ú©ÛŒØ³Ù‡: <b>"+(it.bagPrice==null? "-" : it.bagPrice)+"</b> | Ú©ÛŒÙ„Ùˆ: <b>"+(it.kiloPrice==null? "-" : it.kiloPrice)+"</b>";
    note("âœ… Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø±ÛŒØŒ Ø¨Ú©â€ŒØ¢Ù¾ JSON Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯)");
    // refresh dependent views
    if(typeof renderInventory === "function") renderInventory();
  });

  
  // ===== Analytics Helpers =====
  function ana_norm(d){ return d || ""; }
  function ana_monthKey(d){ if(!d) return ""; return d.slice(0,7); } // yyyy-mm
  function ana_inRange(d, d1, d2){
    const a = d || ""; const s = d1 || "0000-01-01"; const e = d2 || "9999-12-31";
    return a>=s && a<=e;
  }
  function ana_fillSelectors(){
    // group
    const gsel = el("ana-group"); if(gsel){
      const cur = gsel.value;
      const groups = Array.from(new Set(DB.items.map(x=>x.group).filter(Boolean))).sort();
      gsel.innerHTML = "<option value=''>â€” Ù‡Ù…Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ â€”</option>";
      groups.forEach(g=>{ const o=document.createElement("option"); o.value=g; o.textContent=g; gsel.appendChild(o); });
      if(cur && groups.includes(cur)) gsel.value = cur;
    }
    // code by group
    const csel = el("ana-code"); if(csel){
      const g = el("ana-group")?.value || "";
      const cur = csel.value;
      const its = DB.items.filter(i=> !g || i.group===g);
      csel.innerHTML = "<option value=''>â€” Ù‡Ù…Ù‡ Ú©Ø¯Ù‡Ø§ â€”</option>";
      its.forEach(i=>{ const o=document.createElement("option"); o.value=i.code; o.textContent=i.code; csel.appendChild(o); });
      if(cur && its.some(i=> i.code===cur)) csel.value = cur;
    }
  }
  if(el("ana-group")) el("ana-group").addEventListener("change", ana_fillSelectors);

  // ===== Analytics Core (Read-only) =====
  function ana_refresh(){
    const d1 = el("ana-from")?.value || "";
    const d2 = el("ana-to")?.value || "";
    const g  = el("ana-group")?.value || "";
    const c  = el("ana-code")?.value || "";
    const tx = DB.txns
      .filter(t=> t.type==="out") // Ù…ØµØ±Ù = Ø®Ø±ÙˆØ¬
      .filter(t=> ana_inRange(t.date, d1, d2))
      .filter(t=> !c || t.code===c);

    const items = DB.items;
    const groupMap = {}; items.forEach(i=> groupMap[i.code]=i.group);

    // 1) Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡
    const mAgg = {}; // key: yyyy-mm + code
    tx.forEach(t=>{
      if(g && (groupMap[t.code]||"") !== g) return;
      const m = ana_monthKey(t.date);
      const key = m + "|" + t.code;
      mAgg[key] = (mAgg[key]||0) + (+t.qty || +t.quantity || 0);
    });
    const rowsM = Object.entries(mAgg)
      .map(([k,v])=>{
        const [m,code]=k.split("|");
        return {month:m, code, group: groupMap[code]||"", qty: v};
      })
      .sort((a,b)=> (a.month.localeCompare(b.month) || a.code.localeCompare(b.code)));
    renderTable("ana-monthly", ["Ù…Ø§Ù‡","Ú¯Ø±ÙˆÙ‡","Ú©Ø¯","Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø±ÙˆØ¬"], rowsM.map(r=>[r.month,r.group,r.code,r.qty]));

    // 2) Ù¾Ø±Ù…ØµØ±Ùâ€ŒØªØ±ÛŒÙ† Ø±Ù†Ú¯â€ŒÙ‡Ø§ (Top N)
    const cAgg = {}; // by code
    tx.forEach(t=>{
      if(g && (groupMap[t.code]||"") !== g) return;
      const q = (+t.qty || +t.quantity || 0);
      cAgg[t.code] = (cAgg[t.code]||0) + q;
    });
    const topN = Math.max(1, parseInt(el("ana-top-n")?.value||"10",10));
    const rowsTop = Object.entries(cAgg)
      .map(([code,qty])=> ({code, group: groupMap[code]||"", qty}))
      .filter(r=> !c || r.code===c)
      .sort((a,b)=> b.qty - a.qty)
      .slice(0, topN)
      .map((r,i)=> [i+1, r.group, r.code, r.qty]);
    renderTable("ana-top", ["Ø±ØªØ¨Ù‡","Ú¯Ø±ÙˆÙ‡","Ú©Ø¯","Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø±ÙˆØ¬"], rowsTop);

    // 3) Ø¨Ø¯ÙˆÙ† Ù…ØµØ±Ù
    const codesInRange = new Set(tx.filter(t=> !g || (groupMap[t.code]||"")===g).map(t=> t.code));
    const idle = items
      .filter(i=> !g || i.group===g)
      .filter(i=> !c || i.code===c)
      .filter(i=> !codesInRange.has(i.code))
      .sort((a,b)=> (a.group||"").localeCompare(b.group||"", 'fa') || (a.code||"").localeCompare(b.code||"", 'fa'));
    renderTable("ana-idle", ["Ú¯Ø±ÙˆÙ‡","Ú©Ø¯","Ù‚ÛŒÙ…Øª Ú©ÛŒØ³Ù‡","Ù‚ÛŒÙ…Øª Ú©ÛŒÙ„Ùˆ"], idle.map(i=>[i.group||"", i.code, i.bagPrice??"-", i.kiloPrice??"-"]));

    // 4) Ù…ÙˆØ¬ÙˆØ¯ÛŒ + Ø§Ø±Ø²Ø´ Ø±ÛŒØ§Ù„ÛŒ (ØªØ§ Ø§Ù…Ø±ÙˆØ²)
    const bal = {}; DB.txns.forEach(t=>{
      const q = (+t.qty || +t.quantity || 0);
      bal[t.code] = (bal[t.code]||0) + (t.type==='in'? q : -q);
    });
    items.forEach(it=>{ bal[it.code] = (bal[it.code]||0) + (+it.qty||0) });
    const invRows = items
      .filter(i=> !g || i.group===g)
      .filter(i=> !c || i.code===c)
      .map(i=>{
        const qty = +bal[i.code] || 0;
        const kilo = (i.kiloPrice==null? 0 : +i.kiloPrice);
        const value = qty * BAG_SIZE * kilo;
        return {group:i.group||"", code:i.code, qty, bagPrice: (i.bagPrice==null?"-":i.bagPrice), kiloPrice: (i.kiloPrice==null?"-":i.kiloPrice), value};
      })
      .sort((a,b)=> (a.group||"").localeCompare(b.group||"", 'fa') || (a.code||"").localeCompare(b.code||"", 'fa'));
    const totalQty = invRows.reduce((s,r)=> s + (+r.qty||0), 0);
    const totalVal = invRows.reduce((s,r)=> s + (+r.value||0), 0);
    renderTable("ana-value", ["Ú¯Ø±ÙˆÙ‡","Ú©Ø¯","Ù…ÙˆØ¬ÙˆØ¯ÛŒ","Ù‚ÛŒÙ…Øª Ú©ÛŒØ³Ù‡","Ø§Ø±Ø²Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ"], invRows.map(r=>[r.group,r.code,r.qty,r.kiloPrice,r.value]));
    // summary line
    const holder = document.getElementById("ana-value");
    const sum = document.createElement("div"); sum.className="muted"; sum.style.marginTop="6px";
    sum.innerHTML = "Ø¬Ù…Ø¹ Ù…ÙˆØ¬ÙˆØ¯ÛŒ: <b>"+totalQty+"</b> | Ø¬Ù…Ø¹ Ø§Ø±Ø²Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ: <b>"+totalVal+"</b>";
    holder.appendChild(sum);
  }

  function renderTable(holderId, headers, rows){
    const root = document.getElementById(holderId);
    if(!root) return;
    root.innerHTML = "";
    if(!rows || rows.length===0){ root.innerHTML = "<div class='muted'>â€” Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ â€”</div>"; return; }
    const t = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
    thead.appendChild(trh); t.appendChild(thead);
    const tb = document.createElement("tbody");
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      r.forEach(c=>{ const td=document.createElement("td"); td.textContent = (c==null? "": c); tr.appendChild(td); });
      tb.appendChild(tr);
    });
    t.appendChild(tb);
    root.appendChild(t);
  }

  // CSV helpers
  function tableToCSV(holderId){
    const holder = document.getElementById(holderId);
    if(!holder) return "";
    const rows = Array.from(holder.querySelectorAll("table tr"));
    return rows.map(tr=> Array.from(tr.children).map(td=> (td.textContent||"").replace(/,/g," ")).join(",")).join("\n");
  }
  function downloadCSV(name, holderId){
    const csv = tableToCSV(holderId);
    const blob = new Blob([csv], {type:"text/csv"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = name; a.click();
  }
  if(el("ana-monthly-csv")) el("ana-monthly-csv").addEventListener("click", ()=> downloadCSV("monthly_consumption.csv","ana-monthly"));
  if(el("ana-top-csv")) el("ana-top-csv").addEventListener("click", ()=> downloadCSV("top_consumption.csv","ana-top"));
  if(el("ana-idle-csv")) el("ana-idle-csv").addEventListener("click", ()=> downloadCSV("idle_items.csv","ana-idle"));
  if(el("ana-value-csv")) el("ana-value-csv").addEventListener("click", ()=> downloadCSV("inventory_value.csv","ana-value"));

  
  // ===== Single-table PDF exporter for analytics =====
  function ana_exportPDF(holderId, title){
    const node = document.getElementById(holderId);
    if(!node){ alert("Ø¬Ø¯ÙˆÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."); return; }
    const win = window.open("", "_blank");
    const styles = `
      <style>
        @page { size: A4; margin: 16mm; }
        body { font-family: Tahoma, sans-serif; color:#111; }
        h1,h2,h3,h4{ margin:0 0 8px 0; }
        .header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .meta{ color:#6b7280; font-size:12px; }
        table{ width:100%; border-collapse:collapse; }
        th,td{ border:1px solid #e5e7eb; padding:6px; text-align:center; font-size:12px; }
        th{ background:#f3f4f6; }
      </style>`;
    const content = node.cloneNode(true);
    // remove inner toolbars if any
    content.querySelectorAll('.no-print, .toolbar').forEach(e=> e.remove());
    const now = new Date().toLocaleString("fa-IR");
    win.document.write(`<!DOCTYPE html><html dir="rtl" lang="fa"><head><meta charset="utf-8"><title>${title}</title>${styles}</head><body>`);
    win.document.write(`<div class="header"><h2>${title}</h2><div class="meta">${now}</div></div>`);
    win.document.body.appendChild(content);
    win.document.write(`</body></html>`);
    win.document.close();
    setTimeout(()=> win.print(), 300);
  }

  // Bind per-table PDF buttons
  if(el("ana-monthly-pdf")) el("ana-monthly-pdf").addEventListener("click", ()=> ana_exportPDF("ana-monthly","Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø®Ø±ÙˆØ¬)"));
  if(el("ana-top-pdf"))     el("ana-top-pdf").addEventListener("click", ()=> ana_exportPDF("ana-top","Ù¾Ø±Ù…ØµØ±Ùâ€ŒØªØ±ÛŒÙ† Ø±Ù†Ú¯â€ŒÙ‡Ø§"));
  if(el("ana-idle-pdf"))    el("ana-idle-pdf").addEventListener("click", ()=> ana_exportPDF("ana-idle","Ø¨Ø¯ÙˆÙ† Ù…ØµØ±Ù Ø¯Ø± Ø¨Ø§Ø²Ù‡"));
    if(el("ana-moves-pdf"))  el("ana-moves-pdf").addEventListener("click", ()=> ana_exportPDF("ana-moves","ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬ Ø¯Ø± Ø¨Ø§Ø²Ù‡"));
  if(el("ana-value-pdf"))   el("ana-value-pdf").addEventListener("click", ()=> ana_exportPDF("ana-value","Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ² + Ø§Ø±Ø²Ø´ Ø±ÛŒØ§Ù„ÛŒ"));

// PDF (print only the analytics section)
  if(el("ana-pdf")) el("ana-pdf").addEventListener("click", function(){
    const node = el("analytics");
    const win = window.open("", "_blank");
    const styles = `
      <style>
        @page { size: A4; margin: 16mm; }
        body { font-family: Tahoma, sans-serif; color:#111; }
        h1,h2,h3,h4{ margin:0 0 8px 0; }
        .chip{ background:#111827;color:#fff;padding:2px 8px;border-radius:6px;display:inline-block }
        table{ width:100%; border-collapse:collapse; }
        th,td{ border:1px solid #e5e7eb; padding:6px; text-align:center; font-size:12px; }
        th{ background:#f3f4f6; }
      </style>`;
    const content = node.cloneNode(true);
    content.querySelectorAll('.no-print, .toolbar').forEach(e=> e.remove());
    const now = new Date().toLocaleString("fa-IR");
    win.document.write(`<!DOCTYPE html><html dir="rtl" lang="fa"><head><meta charset="utf-8"><title>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ</title>${styles}</head><body>`);
    win.document.write(`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><h2>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ÛŒ</h2><div style="color:#6b7280;font-size:12px">${now}</div></div>`);
    win.document.body.appendChild(content);
    win.document.write(`</body></html>`);
    win.document.close();
    setTimeout(()=> win.print(), 300);
  });

  // Wire refresh
  if(el("ana-refresh")) el("ana-refresh").addEventListener("click", ana_refresh);

  // Ensure analytics selectors refresh with app
  (function(){
    const orig = refreshAll;
    if(typeof orig === "function"){
      window.refreshAll = function(){
        orig();
        ana_fillSelectors();
        // initial render only if there is data
        try{ ana_refresh(); }catch(e){ /* noop to avoid breaking app */ }
      }
    }
  })();

  // ===== Refresh =====
  function refreshAll(){
    fillPriceEditSelectors();
    ["io-group","inv-group","price-group","pl-group","edit-group"].forEach(id=>{
      const sel = el(id);
      if(id==="pl-group") fillGroupSelect(sel, "â€” Ù‡Ù…Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ â€”"); else fillGroupSelect(sel, "â€” Ú¯Ø±ÙˆÙ‡ Ø±Ù†Ú¯ÛŒ â€”");
    // auto-save latest state to LocalStorage
    saveToLocal();
    });
    fillCodeByGroup(el("io-group"), el("io-code"));
    // price codes
    (function(){ const gs=el("price-group"); if(gs) fillPriceCodes(); })();
    // edit codes
    fillEditSelectors();
    /* renderInventory(); (disabled: on-demand) */
    updateZeroAlert();
  }

  // init
  document.addEventListener("DOMContentLoaded", refreshAll);
  refreshAll();
  try{ postProcessDates(); }catch(_e){}
})();
</script>
<script>
// --- Zero-inventory: manual show + PDF export (safe, standalone) ---
(function(){
  function el(id){ return document.getElementById(id); }
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  onReady(function(){
    var showBtn = el('btn-zero-show');
    if(showBtn){
      showBtn.addEventListener('click', function(){
        try{ if(typeof updateZeroAlert==='function') updateZeroAlert(); }catch(e){}
        var zl = el('zero-list'); if(zl) zl.style.display='block';
      });
    }
    var pdfBtn = el('btn-zero-pdf');
    if(pdfBtn){
      pdfBtn.addEventListener('click', function(){
        try{ if(typeof updateZeroAlert==='function') updateZeroAlert(); }catch(e){}
        try{ if(typeof exportPDF==='function') exportPDF('zero-alert', 'Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø¨Ø§ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØµÙØ±'); }catch(e){}
      });
    }
  });

  // ===== Reports: Daily and Range =====
  function rep_table(rootId, headers, rows, caption){
    const root = document.getElementById(rootId);
    if(!root) return;
    root.innerHTML = "";
    if(caption){
      const c = document.createElement("div"); c.className="muted"; c.textContent = caption; root.appendChild(c);
    }
    const t = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
    thead.appendChild(trh); t.appendChild(thead);
    const tb = document.createElement("tbody");
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      r.forEach(c=>{ const td=document.createElement("td"); td.textContent = (c==null? "": c); tr.appendChild(td); });
      tb.appendChild(tr);
    });
    t.appendChild(tb); root.appendChild(t);
  }

  function dateISO(d){ return (d instanceof Date? d: new Date(d)).toISOString().slice(0,10); }
  function prevDate(iso){ const d=new Date(iso); d.setDate(d.getDate()-1); return dateISO(d); }

  function showDailyReport(){
    const date = document.getElementById("rep-date")?.value || todayISO();
    const txs = DB.txns.filter(t=> (t.date||"")===date);
    const byCode = {};
    txs.forEach(t=>{
      const b = byCode[t.code] = byCode[t.code] || {in:0,out:0};
      if(t.type==='in') b.in += +t.qty; else b.out += +t.qty;
    });
    const rows = Object.keys(byCode).sort().map(code=>{
      const it = DB.items.find(i=> i.code===code) || {};
      const inq = byCode[code].in, outq = byCode[code].out;
      const close = (typeof stockOn==='function')? stockOn(code, date) : "";
      return [it.group||"-", code, inq, outq, (inq - outq), close];
    });
    // totals
    const tin = txs.filter(t=> t.type==='in').reduce((s,t)=> s+ +t.qty,0);
    const tout= txs.filter(t=> t.type==='out').reduce((s,t)=> s+ +t.qty,0);
    rows.push(["", "Ø¬Ù…Ø¹", tin, tout, (tin - tout), ""]);
    rep_table("rep-daily", ["Ú¯Ø±ÙˆÙ‡","Ú©Ø¯","ÙˆØ±ÙˆØ¯","Ø®Ø±ÙˆØ¬","Ø®Ø§Ù„Øµ","Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù¾Ø§ÛŒØ§Ù† Ø±ÙˆØ²"], rows, "ØªØ§Ø±ÛŒØ®: "+date);
  }

  function showRangeReport(){
    const from = document.getElementById("rep-from")?.value || "";
    const to   = document.getElementById("rep-to")?.value || "";
    if(!from || !to){ warn("Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø²Ù‡ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
    const txs = DB.txns.filter(t=> (t.date||"")>=from && (t.date||"")<=to);
    const byCode = {};
    txs.forEach(t=>{
      const b = byCode[t.code] = byCode[t.code] || {in:0,out:0};
      if(t.type==='in') b.in += +t.qty; else b.out += +t.qty;
    });
    const rows = Object.keys(byCode).sort().map(code=>{
      const it = DB.items.find(i=> i.code===code) || {};
      const open = (typeof stockOn==='function')? stockOn(code, prevDate(from)) : "";
      const close= (typeof stockOn==='function')? stockOn(code, to) : "";
      const inq = byCode[code].in, outq = byCode[code].out;
      return [it.group||"-", code, open, inq, outq, (inq - outq), close];
    });
    const tin = txs.filter(t=> t.type==='in').reduce((s,t)=> s+ +t.qty,0);
    const tout= txs.filter(t=> t.type==='out').reduce((s,t)=> s+ +t.qty,0);
    rows.push(["", "Ø¬Ù…Ø¹ Ú©Ù„", "", tin, tout, (tin - tout), ""]);
    rep_table("rep-range", ["Ú¯Ø±ÙˆÙ‡","Ú©Ø¯","Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¢ØºØ§Ø²ÛŒÙ†","ÙˆØ±ÙˆØ¯","Ø®Ø±ÙˆØ¬","Ø®Ø§Ù„Øµ","Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù¾Ø§ÛŒØ§Ù†ÛŒ"], rows, "Ø§Ø² "+from+" ØªØ§ "+to);
  }

  // Bindings
  if(document.getElementById("rep-date")) document.getElementById("rep-date").value = todayISO();
  if(document.getElementById("rep-daily-show")) document.getElementById("rep-daily-show").addEventListener("click", showDailyReport);
  if(document.getElementById("rep-range-show")) document.getElementById("rep-range-show").addEventListener("click", showRangeReport);

  // PDF export for the two new tables
  if(document.getElementById("rep-daily-pdf")) document.getElementById("rep-daily-pdf").addEventListener("click", ()=> ana_exportPDF("rep-daily", "Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡"));
  if(document.getElementById("rep-range-pdf")) document.getElementById("rep-range-pdf").addEventListener("click", ()=> ana_exportPDF("rep-range", "Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§Ø²Ù‡â€ŒØ§ÛŒ"));
})();
</script>
</body>
</html>
